<!DOCTYPE html>
  <html lang = "en">
    <head>
        <title>adjectils - Crystal Hollows</title>
        <link rel = "stylesheet" href = "stylesheet.css">
        <meta name = "description" content = "Crystalline utilities for Hypixel SkyBlock">
        <meta name = "author" content = "adjective_n0un">
        <meta name = "viewport" content="width=device-width, initial-scale=0.6">
        <link rel = "apple-touch-icon" sizes = "180x180" href="./favicon/apple-touch-icon.png">
        <link rel = "icon" type = "image/png" sizes = "32x32" href = "./favicon/favicon-32x32.png">
        <link rel = "icon" type = "image/png" sizes = "16x16" href = "./favicon/favicon-16x16.png">
        <link rel = "manifest" href = "./favicon/site.webmanifest">
        <script type="text/javascript" src="/jquery-3.6.3.min.js"></script>
        <script src = "getUUID.js"></script>
        <script src = "timeToMinutes.js"></script>
        <script src = "binomials.js"></script>
        <script src = "crystaldata.js"></script>
    </head>
  <body onload = "updatePage()">
  
      <script>
      $(function(){
        $("#nav").load("nav.html", function() { setWord(); }); 
      });
      </script>
  
    <div id = header style = "margin:auto; text-align:center">
    <a href = "index.html" class = adjheader>adjectils</a><span class = header>&nbsp;|&nbsp;</span><span class = crystalheader>Crystal Hollows</span><br>
    </div>
    <section class = "flex_box_index">

    <label>Username: <input type = "text" onchange = updatePass(value) id = "nameinput"><button onclick = updatePass(nameinput.value) style = "width: 80px; height: 24px; text-align:center; margin-left:10px;">Refresh ⟳</button></label><br>
  <span id = "status">Enter a username to continue.</span><br>
  <span id = "refreshstatus"></span><br>
  <div>
    <form action = "#" style = "background-color: #282828;">
      <label>Profile:
      <select id = profileid value = 4 onchange = updatePass(nameinput.value)>
        <option id = profile0 value = 0>–––––</option>
        <option id = profile1 value = 1>–––––</option>
        <option id = profile2 value = 2>–––––</option>
        <option id = profile3 value = 3>–––––</option>
        <option id = profile4 value = 4>–––––</option>
      </select>
      </label>
    </form>
  </div><br>
  <div class = crystal_block >
    <span class = hollowheader>Pass tracker</span><br><br>
    <div style = "float:left">
        <span>Pass expiration:&nbsp;</span><br>
        <span>Time remaining:&nbsp;</span>
    </div>
    <div style = "display:inline-block">
        <span id = "passexpiration">––:––</span><br>
        <span id = "timeleft">––:––</span>
    </div>
  </div>
  <div class = "flex_index_row">
    <div class = "flex_index_box crystal_block" style = "border-color:#c2c2c2">
        <span class = hollowheader style = "flex-basis:100%; margin-bottom:10px">Crystal Nucleus loot</span><br><br>
        <table style = "margin-bottom: 10px;">
            <tr><td><span> User has High Roller: </span></td>
                <td><label class = "switchbox" for = "hashighroller" id = "highrollerswitch">
                    <input type = "checkbox" id = "hashighroller" onchange = updateHR() aria-labelledby = "highrollerswitch">
                    <span class = "switch"></span></label>
                </td></tr>
            <tr><td style = "width:85%"><span> User has Jasper Crystal: </span></td>
                <td style = "display:flex; justify-content: flex-end;"><label class = "switchbox" for = "hasjc" id = "jcswitch">
                    <input type = "checkbox" id = "hasjc" onchange = updateJC() aria-labelledby = "jcswitch"> 
                    <span class = "switch"></span></label>
                </td></tr>
            <tr><td><span> User has Ruby Crystal: </span></td>
                <td><label class = "switchbox" for = "hasrc" id = "rcswitch">
                    <input type = "checkbox" id = "hasrc" onchange = updateRC() aria-labelledby = "rcswitch">
                    <span class = "switch"></span></label>
                </td></tr>
            <tr><td><span> User has Mole Pet: </span></td>
                <td><label class = "switchbox" for = "hasmole" id = "moleswitch">
                    <input type = "checkbox" id = "hasmole" onchange = updateMole() aria-labelledby = "moleswitch">
                    <span class = "switch"></span></label>
                </td></tr>
        </table>
        <br>
        <table>
            <tr>
                <td><span>Chance of Bob-omb ×16: &nbsp;</span></td><td><span id = "chance_bombs">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Pickonimbus 2000: &nbsp;</span></td><td><span id = "chance_pick2k">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Oil Barrel: &nbsp;</span></td><td><span id = "chance_oil">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Divan Fragment: &nbsp;</span></td><td><span id = "chance_divan_fragment">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Prehistoric Egg: &nbsp;</span></td><td><span id = "chance_arma_egg">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Helix Fossil: &nbsp;</span></td><td><span id = "chance_helix">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Jasper Crystal: &nbsp;</span></td><td><span id = "chance_crystal_jasper">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Ruby Crystal: &nbsp;</span></td><td><span id = "chance_crystal_ruby">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Treasurite ×5: &nbsp;</span></td><td><span id = "chance_treasurite5">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Treasurite ×10: &nbsp;</span></td><td><span id = "chance_treasurite10">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Jaderald: &nbsp;</span></td><td><span id = "chance_jaderald">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Gold Essence ×10: &nbsp;</span></td><td><span id = "chance_essence_gold">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Diamond Essence ×10: &nbsp;</span></td><td><span id = "chance_essence_diamond">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Gemstone Mixture: &nbsp;</span></td><td><span id = "chance_gemmix">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Fortune IV book: &nbsp;</span></td><td><span id = "chance_book_fortune">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Wishing Compass ×3: &nbsp;</span></td><td><span id = "chance_compass">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Precious Pearl: &nbsp;</span></td><td><span id = "chance_preciouspearl">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Claw Fossil: &nbsp;</span></td><td><span id = "chance_claw">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Recall Potion: &nbsp;</span></td><td><span id = "chance_recall">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Quick Claw: &nbsp;</span></td><td><span id = "chance_quick_claw">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Flawless Ruby Gemstone: &nbsp;</span></td><td><span id = "chance_fl_ruby">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Flawless Amethyst Gemstone: &nbsp;</span></td><td><span id = "chance_fl_amethyst">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Flawless Jade Gemstone: &nbsp;</span></td><td><span id = "chance_fl_jade">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Flawless Amber Gemstone: &nbsp;</span></td><td><span id = "chance_fl_amber">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Flawless Sapphire Gemstone: &nbsp;</span></td><td><span id = "chance_fl_sapphire">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Flawless Topaz Gemstone: &nbsp;</span></td><td><span id = "chance_fl_topaz">Loading...</span></td>
            </tr>
            <tr>
                <td><span>Chance of Flawless Jasper Gemstone: &nbsp;</span></td><td><span id = "chance_fl_jasper">Loading...</span></td>
            </tr>
        </table>

    </div>
  </div>
  </section>
  <div id = "nav" style = "width:min(calc(100% - 30px), max(600px, 40%)); margin:auto" class = "crystal_block"></div>
  </body>
  <script>
    var lastname = "";
    var hr = 0;
    var mole = 0;
    var hasruby = 0;
    var hasjasper = 0;
    var onCD = false;
    var data;
    var purchasetime;
    var fasttrack = false;
    var intervalID = [""];
    function resetStatuses(){
        document.getElementById("passexpiration").innerText = "N/A";
        document.getElementById("timeleft").innerText = "––:––";
    }
    async function updatePass(name){
        if (onCD == true){
            document.getElementById("refreshstatus").innerText = "Please wait 5 seconds before using this again.";
            console.log("On cooldown!");
            return -1;
        } else {
            document.getElementById("refreshstatus").innerText = "";
            if (!fasttrack){
                onCD = true;
                setTimeout(() => { onCD = false }, 5000);
            }
        }
        purchasetime = 0;
        console.log(intervalID);
        document.getElementById("passexpiration").innerText = "––:––";
        document.getElementById("timeleft").innerText = "––:––";
        clearInterval[intervalID[0]];
        //intervalID[0] = "";
        UUID = await getUUIDbyName(name);
        if (UUID == -1) {
            return -1;
        }
        if (!fasttrack){
            data = await getAPIdata(UUID);
        }
        fasttrack = false;
        
        try {
                profilelist = (data.profiles);
                for (var i = 0; i < 5; i++){
                    document.getElementById("profile" + i).innerText = "–––––";
                }
                for (var i = 0; i < profilelist.length; i++){
                    document.getElementById("profile" + i).innerText = profilelist[i].cute_name;
                }
          
                console.log("Checking new name");
                var profilenum = 0;
                for (var i = 0; i < profilelist.length; i++){
                    if (profilelist[i].selected){
                        console.log("Profile ID found: " + profilenum);
                        profilenum = i;
                        break;
                    }
                }
                document.getElementById("profileid").value = profilenum;    
            } catch (TypeError){
                document.getElementById("status").innerHTML = "<span class = errored>No profiles found</span>";
            }
            console.log("Last name: " + lastname + " New name: " + name);
            lastname = name;
            localStorage.setItem("storedname", name);
            localStorage.setItem("storeddata", JSON.stringify(data));
            fasttrack = false;
        
        try {
            purchasetime = data.profiles[profileid.value].members[UUID].mining_core.greater_mines_last_access;
            console.log(purchasetime);
            if (purchasetime == undefined) {
                document.getElementById("passexpiration").innerText = "N/A";
                document.getElementById("timeleft").innerText = "––:––";
            } else {
                var finaltime = new Date(purchasetime + 21600000);
                document.getElementById("passexpiration").innerText = finaltime.getHours() + ":" + fixTime(finaltime.getMinutes()) + ":" + fixTime(finaltime.getSeconds()) + " – " + months[finaltime.getMonth()] + " " + finaltime.getDate();
                if (Date.now() > purchasetime + 21600000){
                    document.getElementById("timeleft").innerText = "––:––";
                } else {
                    var interval = setInterval(updateTimers, 1000);
                    intervalID[0] = interval;  
                    console.log("Set interval: " + intervalID);
                }
            } 
        } catch (TypeError) {
            //console.log("No data found");
            //document.getElementById("status").innerText = "This profile has no Crystal Hollows data!";
        }
        
    }
    function updateMole(){
        mole = Math.abs(mole - 1);
        updateChances();
    }
    function updateRC(){
        hasruby = Math.abs(hasruby - 1);
        updateChances();
    }
    function updateJC(){
        hasjasper = Math.abs(hasjasper - 1);
        updateChances();
    }
    function updateHR(){
        hr = Math.abs(hr - 1);
        updateChances();
    }
    function updateChances(){
        if (hasruby == 1){
            console.log("User has Ruby Crystal");
            nucweights["crystal_ruby"] = 0;
        } else {
            nucweights["crystal_ruby"] = 2500;
        }
        if (hasjasper == 1){
            console.log("User has Jasper Crystal");
            nucweights["crystal_jasper"] = 0;
        } else {
            nucweights["crystal_jasper"] = 2500;
        }
        console.log("Mole: " + mole); 
        var totalweight = totalnucweight + nucweights["crystal_ruby"] + nucweights["crystal_jasper"];
        console.log("Total weight: " + totalweight);
        for (var key in nucweights){
            //console.log("Key: " + key); 
            try {
                var apxdropchance = 0;
                for (var j = 14 + hr + mole; j <= 20 + hr + mole; j++){
                    //console.log("J: " + j + " nucweights[key]: " + nucweights[key] + " Total nuc weight: " + totalweight + " Drop chance: " + (nucweights[key] / totalweight));
                    apxdropchance += ((1/7) * binomial(j, nucweights[key]/totalweight));
                }
                document.getElementById("chance_" + key).innerText = (apxdropchance * 100).toFixed(3) + "%";
                //console.log((apxdropchance * 100).toFixed(3) + "%");
            } catch (ReferenceError) {
               //console.log("adj opted not to put " + key + " in the table.");
            }
            
        }
        console.log("Done");
    }
    async function updateTimers() {
        var endtime = Math.floor(purchasetime/1000) + 21600;
        var timediff = endtime - Math.floor(Date.now() / 1000);
        if (timediff > 0){
            document.getElementById("timeleft").innerText = timeToMinutes(timediff);
        } else {
            document.getElementById("timeleft").innerText = "––:––";
            clearInterval(intervalID[0]);
            intervalID[0] = "";
        }
        
        
    }
    function updatePage(){
        updateChances();
        console.log("Stored a name: " + localStorage.getItem("storedname"));
        if (localStorage.getItem("storedname") != null && localStorage.getItem("storeddata") != null){
            console.log("Found a previous name and data! Loading...");
            console.log("Previous name: " + localStorage.getItem("storedname"));
            console.log("Previous data: " + localStorage.getItem("storeddata"));
            document.getElementById("nameinput").value = localStorage.getItem("storedname");
            data = JSON.parse(localStorage.getItem("storeddata"));
            fasttrack = true;
            updatePass(localStorage.getItem("storedname"));
        }
        
    }
    
  </script>